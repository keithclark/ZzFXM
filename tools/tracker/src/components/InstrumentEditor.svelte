<script>
import { instrumentsMeta, patterns, instruments } from '../stores.js';
import { playNote } from '../services/RendererService.js';
import { getNoteName } from '../services/PatternService.js';
import { clearSampleCacheForInstrument } from '../services/SampleRendererService.js';
import { addInstrument, deleteInstrument, setInstrumentParams } from '../services/InstrumentService.js';
import { decodeInstrument, encodeInstrument } from 'zzfxm-song-encoder';
import { clamp } from '../lib/utils.js';
import { tick } from 'svelte';
import Pane from './Pane.svelte';
import Toolbar from './Toolbar.svelte';
import Button from './Button.svelte';
import ToggleButton from './ToggleButton.svelte';
import Field from './Field.svelte';
import Property from './Property.svelte';
import TextProperty from './TextProperty.svelte';
import NumberProperty from './NumberProperty.svelte';
import SampleViewer from './SampleViewer.svelte';
import InstrumentPicker from './InstrumentPicker.svelte';
import Modal from './Modal.svelte';

export let selected = 0;

const notelist = new Array(36).fill(0).map((value, index) => {
  return {
    id: index + 1,
    label: getNoteName(index + 2)
  }
});

const shapeOptions = [
  {id: 0, label: 'Sin'},
  {id: 1, label: 'Triangle'},
  {id: 2, label: 'Saw'},
  {id: 3, label: 'Tan'},
  {id: 4, label: 'Bit Noise'},
];

let clipboard;
let showInstrumentPicker = false;
let playOnChange = true;
let testNote = 13;
let currentNote;

const waveformCache = new WeakMap();

$: selected = clamp(selected, 0, $instruments.length - 1);
$: instrument = $instruments[selected];
$: buffer = getWave(instrument);
$: usage = $patterns.map((pattern, i) => {
  return pattern.some(channel => channel[0] === selected) && i
}).filter(x => x !== false);

const getWave = (instrument, recache) => {
  if (recache || !waveformCache.has(instrument)) {
    const buffer = zzfxG(...instrument);
    const step = Math.max(1, (buffer.length / 2000) | 0);
    const previewBuffer = buffer.filter((v, i) => i % step === 0);
    waveformCache.set(instrument, previewBuffer);
  }
  return waveformCache.get(instrument);
};

const playTestNote = async (instrument, note) => {
  if (currentNote) {
    currentNote.stop();
  }
  currentNote = await playNote(instrument, note);
}

const handlePlayClick = () => {
  playTestNote(selected, testNote);
}

const handleChange = async () => {
  clearSampleCacheForInstrument(selected);
  if (playOnChange) {
    playTestNote(selected, testNote);
  }
  await tick();
  buffer = getWave(instrument, true);
}

const handleImportClick = () => {
  let code = prompt('Zzfx Code', `zzfx(...[])`);
  if (code) {
    code = code.replace(/zzfx\(\.\.\.(\[[\w\W]*?\])\)/, '$1');
    setInstrumentParams(selected, decodeInstrument(code));
  }
}

const handleExportClick = () => {
  prompt('Zzfx Code', `zzfx(...${encodeInstrument(instrument)})`);
}

const handleAddClick = () => {
  addInstrument([1,0]);
  selected = $instruments.length - 1;
}

const handleDeleteClick = () => {
  if (usage.length > 0) {
    alert(`This instrument is being used in patterns ${usage}.`)
  } else {
    deleteInstrument(selected);
    selected = Math.min(selected,$instruments.length - 1);
  }
}

const handleSelectClick = () => {
  showInstrumentPicker = true;
}

const handleInstrumentApply = e => {
  setInstrumentParams(selected, e.detail.params);
  $instrumentsMeta[selected] = e.detail.name;
  showInstrumentPicker = false;
}

const copy = () => {
  clipboard = instrument.slice();
}

const paste = () => {
  $instruments[selected] = clipboard.slice();
  $instruments = $instruments;
}
</script>


<div class="splitView">
  <Pane>
    <div slot="head">
      <Toolbar>
        <Field label="Instruments">
          <Button label="Add" on:click={handleAddClick} />
          <Button label="Delete" disabled={usage.length} on:click={handleDeleteClick} />
          <Button label="Copy" on:click={copy}  />
          <Button label="Paste" on:click={paste} disabled={!clipboard} />
        </Field>
      </Toolbar>
    </div>
    <select class="select" bind:value={selected} size="2">
      {#each $instrumentsMeta as instrument, i}
        <option value={i}>{i}: {instrument}</option>
      {/each}
    </select>
  </Pane>

  <Pane>
    <div slot="head">
      <Toolbar>
        <NumberProperty min={0} max={$instruments.length - 1} label="#" bind:value={selected} />
        <TextProperty label="Name" bind:value={$instrumentsMeta[selected]} />
        <Field label="Playback">
          <Button label="Play" on:click={handlePlayClick} />
          <select class="select" bind:value={testNote}>
            {#each notelist as note}
              <option value={note.id}>{note.label}</option>
            {/each}
          </select>
          <ToggleButton hint="Automatically play when changing properties" label="Auto Play" bind:checked={playOnChange} />
        </Field>
        <Field label="Parameters">
          <Button label="Import" on:click={handleImportClick} />
          <Button label="Export" on:click={handleExportClick} />
          <Button label="Library" on:click={handleSelectClick} />
        </Field>
        <Field label="Pattern Usage"><span class="usage output">{usage.length ? usage : 'Unused'}</span></Field>
        <div class="outset"></div>
      </Toolbar>
    </div>

    <div class="instrument">
      <div class="instrument__params">
        <NumberProperty size={4} label="Volume" hint="Volume scale (percent)" min="0" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[0]} />
        <NumberProperty size={4} label="Frequency" hint="Frequency of sound (Hz)" min="-1000000000" max="1000000000" step="1" on:input={handleChange} bind:value={instrument[2]} />
        <Property label="Shape">
          <select class="select" on:input={handleChange} bind:value={instrument[6]}>
            {#each shapeOptions as option}
              <option value={option.id}>{option.label}</option>
            {/each}
          </select>
        </Property>
        <NumberProperty size={4} label="Attack" hint="Attack time, how fast sound starts (seconds)" min="0" max="3" step="0.01" on:input={handleChange} bind:value={instrument[3]} />
        <NumberProperty size={4} label="Sustain" hint="Sustain time, how long sound holds (seconds)" min="0" max="3" step="0.01" on:input={handleChange} bind:value={instrument[4]} />
        <NumberProperty size={4} label="Release" hint="Release time, how fast sound fades out (seconds)" min="0" max="3" step="0.01" on:input={handleChange} bind:value={instrument[5]} />
        <NumberProperty size={4} label="Shape Curve" hint="Squarenes of wave (0=square, 1=normal, 2=pointy)" min="0" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[7]} />
        <NumberProperty size={4} label="Slide" hint="How much to slide frequency (kHz/s)" min="-1000000000" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[8]} />
        <NumberProperty size={4} label="Delta Slide" hint="How much to change slide (kHz/s/s)" min="-1000000000" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[9]} />
        <NumberProperty size={4} label="Pitch Jump" hint="Frequency of pitch jump (Hz)" min="-1000000000" max="1000000000" step="10" on:input={handleChange} bind:value={instrument[10]} />
        <NumberProperty size={4} label="Pitch Jump Time" hint="Time of pitch jump (seconds)" min="-1000000000" max="1000000000" step="0.01" on:input={handleChange} bind:value={instrument[11]} />
        <NumberProperty size={4} label="Repeat Time" hint="Resets some parameters periodically (seconds)" min="-1000000000" max="1000000000" step="0.01" on:input={handleChange} bind:value={instrument[12]} />
        <NumberProperty size={4} label="Noise" hint="How much random noise to add (percent)" min="-1000000000" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[13]} />
        <NumberProperty size={4} label="Modulation" hint="Frequency of modulation wave, negative flips phase (Hz)" min="-1000000000" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[14]} />
        <NumberProperty size={4} label="Bit Crush" hint="Resamples at a lower frequency in (samples*100)" min="-1000000000" max="1000000000" step="0.1" on:input={handleChange} bind:value={instrument[15]} />
        <NumberProperty size={4} label="Delay" hint="Overlap with itself for reverb and flanger effects (seconds)" min="0" max="1000000000" step="0.01" on:input={handleChange} bind:value={instrument[16]} />
        <NumberProperty size={4} label="Sustain Volume" hint="Volume level for sustain (percent)" min="0" max="1000000000" step="0.01" on:input={handleChange} bind:value={instrument[17]} />
        <NumberProperty size={4} label="Decay" hint="Decay time, how long to reach sustain after attack" min="0" max="1" step="0.01" on:input={handleChange} bind:value={instrument[18]} />
        <NumberProperty size={4} label="Tremolo" hint="Trembling effect, rate controlled by repeat time (precent)" min="0" max="1" step="0.01" on:input={handleChange} bind:value={instrument[19]} />
        <div class="outset"></div>
        <div class="outset"></div>
      </div>
      <div class="instrument__preview outset">
        <SampleViewer data={buffer} />
      </div>
    </div>
  </Pane>
</div>

<Modal title="Select an instrument" bind:open={showInstrumentPicker}>
  <InstrumentPicker on:apply={handleInstrumentApply} />
</Modal>

<style>
.instrument {
  display: flex;
}

.instrument__params {
  display: grid;
  grid-template-columns: repeat(3, 14em);
}

.instrument__preview {
  flex: 1;
}

.usage {
  min-width: 8em;
  max-width: 17em;
  overflow: auto;
}
</style>